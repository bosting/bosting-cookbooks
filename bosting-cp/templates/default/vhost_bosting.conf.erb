# Generated by Chef, do not edit

upstream unicorn_bosting {
  server unix:/home/bosting/bosting-cp/tmp/sockets/unicorn.sock;
}

server {
  reset_timedout_connection on;
  listen <%= node['bosting-cp']['ip'] %>:80;
  server_name <%= node['bosting-cp']['panel_domain'] %>;
<%- if node['bosting-cp']['panel_ssl'] -%>
  return 301 https://<%= node['bosting-cp']['panel_domain'] %>$1;
}

server {
  reset_timedout_connection on;
  listen <%= node['bosting-cp']['ip'] %>:443 ssl;
  server_name <%= node['bosting-cp']['panel_domain'] %>;

  ssl_certificate <%= @nginx_conf_base %>/ssl/<%= @panel_domain %>/<%= @panel_domain %>.crt;
  ssl_certificate_key <%= @nginx_conf_base %>/ssl/<%= @panel_domain %>/<%= @panel_domain %>.key;
  add_header Strict-Transport-Security "max-age=31536000;";
<%- end -%>

  root /home/bosting/bosting-cp/public;

<%- %w(phpmyadmin phppgadmin roundcube).each do |site| -%>
  location /<%= site %>/ {
    proxy_set_header Host $http_host;
    #proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_pass http://127.0.0.1:80/<%= site %>/;

    <%- if @https -%>
    proxy_redirect http://<%= @panel_domain %>/ https://<%= @panel_domain %>/;
    <%- end -%>
  }

<%- end -%>

  location / {
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http<%= @https %>;
    proxy_redirect off;

    if (-f $request_filename/index.html) {
      rewrite (.*) $1/index.html break;
    }
    if (-f $request_filename.html) {
      rewrite (.*) $1.html break;
    }
    if (!-f $request_filename) {
      proxy_pass http://unicorn_bosting;
      break;
    }
  }

  #	location ~* ^.+\.(css|js)$ {
    #		expires max;
    #	}

    gzip on;
    gzip_proxied any;
    gzip_comp_level 1;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_buffers 16 8k;
    # Some version of IE 6 don't handle compression well on some mime-types, so just disable for them
    gzip_disable "MSIE [1-6].(?!.*SV1)";
    # Set a vary header so downstream proxies don't send cached gzipped content to IE6
    gzip_vary on;
  }
